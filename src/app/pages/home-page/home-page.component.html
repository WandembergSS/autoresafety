<section class="page">
  <header class="page__header">
    <h2>ReSafety Project Workspace</h2>
    <p>
      Coordinate ReSafety project capture and the 7-step workflow for every safety-critical system under analysis.
    </p>
  </header>

  <div class="page__grid">
    <form class="card" [formGroup]="projectForm" (ngSubmit)="createProject()">
      <h3>Start a new analysis</h3>
      <div class="field">
        <label for="project-name">Project name</label>
        <input
          id="project-name"
          type="text"
          formControlName="name"
          placeholder="e.g. Automated Insulin Delivery (AID) System"
        />
        @if (projectForm.controls.name.invalid && projectForm.controls.name.touched) {
          <small class="hint">Provide a descriptive name (min. 4 characters).</small>
        }
      </div>

      <div class="field">
        <label for="project-domain">Operational domain</label>
        <input
          id="project-domain"
          type="text"
          formControlName="domain"
          placeholder="e.g. Medical IoT, Urban Mobility, Aviation"
        />
      </div>

      <div class="field">
        <label for="project-owner">Lead analyst</label>
        <input
          id="project-owner"
          type="text"
          formControlName="owner"
          placeholder="Assign the RESafety facilitator"
        />
      </div>

      <div class="field">
        <label for="project-description">Mission overview</label>
        <textarea
          id="project-description"
          rows="3"
          formControlName="description"
          placeholder="Summarise mission intent, key stakeholders, and why the analysis matters."
        ></textarea>
      </div>

      <button type="submit" class="primary">Create project charter</button>
    </form>

    <section class="card card--summary">
      <h3>7-step ReSafety timeline</h3>
      <ol>
        <li>
          Define SCS scope via the ReSafety scope canvas (mission, hazards, constraints).
          <ol class="sub-steps">
            <li>Define General Concerns</li>
            <li>Identify Safety Concerns</li>
            <li>Assign Responsibilities</li>
          </ol>
        </li>
        <li>
          Refine iStar4Safety models to map actors, goals, and responsibilities.
          <ol class="sub-steps">
            <li>Strategic Dependency (SD) Model</li>
            <li>Strategic Rationale (SR) Model</li>
            <li>Integrate Safety Goals</li>
          </ol>
        </li>
        <li>
          Derive the STPA control structure and feedback architecture.
          <ol class="sub-steps">
            <li>Identify Controllers and Processes</li>
            <li>Derive Control Actions</li>
            <li>Refine Feedback Architecture (Optional)</li>
          </ol>
        </li>
        <li>
          Evaluate control actions across STPA contexts to expose UCAs.
          <ol class="sub-steps">
            <li>Evaluate Failure Situations</li>
            <li>Link UCAs to Hazards</li>
            <li>Model Hazardous Conditions (HC)</li>
          </ol>
        </li>
        <li>
          Translate UCAs into controller constraints and assurance checks.
          <ol class="sub-steps">
            <li>Analyze UCAs and HCs</li>
            <li>Formulate Constraints</li>
          </ol>
        </li>
        <li>
          Analyse loss scenarios and author safety requirements for mitigation.
          <ol class="sub-steps">
            <li>Identify Loss Scenarios (LS)</li>
            <li>Author Safety Requirements (SR)</li>
            <li>Ensure Traceability</li>
          </ol>
        </li>
        <li>
          Update iStar4Safety artefacts and log evidence for traceability.
          <ol class="sub-steps">
            <li>Integrate Findings</li>
            <li>Log Traceability Evidence</li>
            <li>Verify Model Consistency</li>
          </ol>
        </li>
      </ol>
    </section>
  </div>

  <section class="list">
    <header class="list__header">
      <h3>Pending analyses</h3>
  <p>{{ pendingProjects().length }} active projects</p>
    </header>

    @if (pendingProjects().length === 0) {
  <p class="empty">No active analyses. Create a charter to start Step 1 (Scope).</p>
    } @else {
      <div class="list__grid">
        @for (project of pendingProjects(); track project.id) {
          <article class="tile">
            <div class="tile__heading">
              <h4>{{ project.name }}</h4>
              <span class="status status--{{ project.status }}">{{ project.status }}</span>
            </div>
            <p class="tile__meta">
              <strong>Domain:</strong> {{ project.domain }} · <strong>Lead analyst:</strong>
              {{ project.owner ?? 'Unassigned' }}
            </p>
            <p class="tile__description">{{ project.description }}</p>
            <p class="tile__next">
              Current stage: Step {{ project.currentStep ?? '—' }} · {{ project.nextStep }}
            </p>
            <div class="tile__actions">
              @if (project.status === 'pending') {
                <button type="button" (click)="startProject(project)">Start</button>
              } @else {
                <button type="button" (click)="continueProject(project)">Continue</button>
              }
              <button type="button" (click)="updateStatus(project.id, 'complete')">Mark complete</button>
              <button type="button" class="danger" (click)="removeProject(project.id)">Remove</button>
            </div>
          </article>
        }
      </div>
    }
  </section>

  <section class="list">
    <br>
    <header class="list__header">
      <h3>Concluded analyses</h3>
      <p>{{ completedProjects().length }} archived traceability packages</p>
    </header>

    @if (completedProjects().length === 0) {
      <p class="empty">No completed projects yet. Finish a workflow to see history here.</p>
    } @else {
      <div class="list__grid list__grid--compact">
        @for (project of completedProjects(); track project.id) {
          <article class="tile tile--compact">
              <div class="tile__heading">
                <h4>{{ project.name }}</h4>
                <span class="status status--complete">Complete</span>
              </div>
              <p class="tile__meta">
                <strong>Domain:</strong> {{ project.domain }} · <strong>Lead analyst:</strong>
                {{ project.owner ?? 'Unassigned' }}
              </p>
              <p class="tile__description">{{ project.description }}</p>
              <div class="tile__actions">
                <button type="button" (click)="updateStatus(project.id, 'pending')">Reopen</button>
                <button type="button" class="danger" (click)="removeProject(project.id)">Remove</button>
              </div>
          </article>
        }
      </div>
    }
  </section>
</section>
