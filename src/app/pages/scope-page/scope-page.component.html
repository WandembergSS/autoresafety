<section class="page">
  <header class="page__header">
    <p class="step">Step 1</p>
    <h2>Define the Scope of the Safety-Critical System</h2>
    <p>
  Populate the ReSafety project rationale and project scope blocks. Establish the mission context, hazards, and
      high-level constraints that guide the remaining RESafety analysis.
    </p>
  </header>

  <div class="page-actions">
    <button type="button" class="button button--secondary" (click)="saveStepOne()">Save</button>
    <button type="button" class="button" (click)="saveStepOne(true)">Save and Continue</button>
  </div>

  <section class="card lane">
    <header class="lane__header">
      <h3>1.1 — General concerns</h3>
      <p>
        Build a shared understanding of the mission, system definition, available knowledge, scope
        boundaries, and the socio-technical elements that will influence subsequent ReSafety artefacts.
      </p>
    </header>

    <div class="lane__grid">
      <article class="lane__block">
        <header>
          <h4>1.1.1 Clarify analysis objectives</h4>
          <p>Capture the intent of this iteration.</p>
        </header>
        <form class="stack" [formGroup]="analysisObjectiveForm">
          <label class="field">
            <textarea
              rows="4"
              formControlName="objectivesText"
              placeholder="Describe the analysis objectives for Step 1"
            ></textarea>
          </label>
          <div class="field-actions">
            <button type="button" class="button button--ai">Generate with AI</button>
            <button type="button" (click)="openObjectiveModal()">Expand</button>
          </div>
        </form>
      </article>

      <article class="lane__block">
        <header>
          <h4>1.1.2 System definition</h4>
          <p>Briefly introduce the system, along with a concise explanation of its purpose.</p>
        </header>
        <form [formGroup]="generalSummaryForm" class="stack">
          <label class="field">
            <textarea
              rows="4"
              formControlName="systemDefinition"
              placeholder="Describe the system definition"
            ></textarea>
          </label>
          <div class="field-actions">
            <button type="button" class="button button--ai">Generate with AI</button>
            <button type="button" (click)="openSystemDefinitionModal()">Expand</button>
          </div>
        </form>
      </article>

      <article class="lane__block">
        <header>
          <h4>1.1.3 Resources Needed ({{ resourceCount() }})</h4>
          <p>List supporting material that will inform hazards, constraints, and responsibilities.</p>
        </header>
        <form class="inline-form" [formGroup]="resourceForm" (ngSubmit)="addResource()">
          <input type="text" formControlName="name" placeholder="Resource name" />
          <input type="text" formControlName="category" placeholder="Type" />
          <input type="text" formControlName="reference" placeholder="Reference or link" />
          <button type="submit">Add</button>
        </form>
        @if (resourceForm.controls.name.invalid && resourceForm.controls.name.touched) {
          <small class="hint">Resource name is required.</small>
        }
        <div class="field-actions">
          <button type="button" class="button button--ai">Generate with AI</button>
          <button type="button" (click)="openResourceModal()">Expand</button>
        </div>
        <ul class="list list--dense">
          @for (resource of resources(); track resource.id) {
            <li>
              <div>
                <h5>{{ resource.name }}</h5>
                <p>{{ resource.category }} · {{ resource.reference }}</p>
              </div>
              <button
                type="button"
                class="icon-button"
                aria-label="Remove resource"
                (click)="removeResource(resource.id)"
              >
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path
                    d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM6 9h2v9H6V9z"
                    fill="currentColor"
                  />
                </svg>
              </button>
            </li>
          }
        </ul>
      </article>

      <article class="lane__block">
        <header>
          <h4>1.1.4 System boundary</h4>
          <p>Boundaries of the system under analysis.</p>
        </header>
        <form [formGroup]="generalSummaryForm" class="stack">
          <label class="field">
            <textarea
              rows="4"
              formControlName="systemBoundary"
              placeholder="Describe the system boundary"
            ></textarea>
          </label>
          <div class="field-actions">
            <button type="button" class="button button--ai">Generate with AI</button>
            <button type="button" (click)="openSystemBoundaryModal()">Expand</button>
          </div>
        </form>
      </article>

      <article class="lane__block">
        <header>
          <h4>1.1.5 System components ({{ componentCount() }})</h4>
          <p>Basic components of the system.</p>
        </header>
        <form class="inline-form" [formGroup]="componentForm" (ngSubmit)="addComponent()">
          <input type="text" formControlName="name" placeholder="Component" />
          <input type="text" formControlName="description" placeholder="Description" />
          <button type="submit">Add</button>
        </form>
        @if (componentForm.controls.name.invalid && componentForm.controls.name.touched) {
          <small class="hint">Component name is required.</small>
        }
        <div class="field-actions">
          <button type="button" class="button button--ai">Generate with AI</button>
          <button type="button" (click)="openComponentModal()">Expand</button>
        </div>
        <ul class="list">
          @for (component of systemComponents(); track component.id) {
            <li>
              <div>
                <h5>{{ component.name }}</h5>
                <p>{{ component.description }}</p>
              </div>
              <button
                type="button"
                class="icon-button"
                aria-label="Remove component"
                (click)="removeComponent(component.id)"
              >
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path
                    d="M9 3h6l1 2h4v2H4V5h4l1-2zm1 6h2v9h-2V9zm4 0h2v9h-2V9zM6 9h2v9H6V9z"
                    fill="currentColor"
                  />
                </svg>
              </button>
            </li>
          }
        </ul>
      </article>
    </div>
  </section>

  @if (isObjectiveModalOpen()) {
    <div class="modal-backdrop" (click)="closeObjectiveModal()">
      <div class="modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">
        <header class="modal__header">
          <h4>Analysis objectives</h4>
          <button type="button" class="modal__close" (click)="closeObjectiveModal()">×</button>
        </header>
        <form class="stack" [formGroup]="analysisObjectiveModalForm">
          <label class="field">
            <textarea
              rows="12"
              formControlName="objectivesText"
              placeholder="Describe the analysis objectives for Step 1"
            ></textarea>
          </label>
          <div class="form__actions">
            <button type="button" class="primary" (click)="confirmObjectiveModal()">Finish</button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (isSystemDefinitionModalOpen()) {
    <div class="modal-backdrop" (click)="closeSystemDefinitionModal()">
      <div class="modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">
        <header class="modal__header">
          <h4>System definition</h4>
          <button type="button" class="modal__close" (click)="closeSystemDefinitionModal()">×</button>
        </header>
        <form class="stack" [formGroup]="systemDefinitionModalForm">
          <label class="field">
            <textarea
              rows="12"
              formControlName="systemDefinitionText"
              placeholder="Describe the system definition"
            ></textarea>
          </label>
          <div class="form__actions">
            <button type="button" class="primary" (click)="confirmSystemDefinitionModal()">Finish</button>
          </div>
        </form>
      </div>
    </div>
  }

  @if (isResourceModalOpen()) {
    <div class="modal-backdrop" (click)="closeResourceModal()">
      <div class="modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">
        <header class="modal__header">
          <h4>Resources needed</h4>
          <button type="button" class="modal__close" (click)="closeResourceModal()">×</button>
        </header>
        <form class="inline-form" [formGroup]="resourceModalForm" (ngSubmit)="addResource(resourceModalForm)">
          <input type="text" formControlName="name" placeholder="Resource name" />
          <input type="text" formControlName="category" placeholder="Type" />
          <input type="text" formControlName="reference" placeholder="Reference or link" />
          <button type="submit">Add</button>
        </form>
        @if (resourceModalForm.controls.name.invalid && resourceModalForm.controls.name.touched) {
          <small class="hint">Resource name is required.</small>
        }
        <ul class="list list--dense">
          @for (resource of resources(); track resource.id) {
            <li>
              <div>
                <h5>{{ resource.name }}</h5>
                <p>{{ resource.category }} · {{ resource.reference }}</p>
              </div>
            </li>
          }
        </ul>
        <div class="form__actions">
          <button type="button" class="primary" (click)="confirmResourceModal()">Finish</button>
        </div>
      </div>
    </div>
  }

  @if (isComponentModalOpen()) {
    <div class="modal-backdrop" (click)="closeComponentModal()">
      <div class="modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">
        <header class="modal__header">
          <h4>System components</h4>
          <button type="button" class="modal__close" (click)="closeComponentModal()">×</button>
        </header>
        <form class="inline-form" [formGroup]="componentModalForm" (ngSubmit)="addComponent(componentModalForm)">
          <input type="text" formControlName="name" placeholder="Component" />
          <input type="text" formControlName="description" placeholder="Description" />
          <button type="submit">Add</button>
        </form>
        @if (componentModalForm.controls.name.invalid && componentModalForm.controls.name.touched) {
          <small class="hint">Component name is required.</small>
        }
        <ul class="list">
          @for (component of systemComponents(); track component.id) {
            <li>
              <div>
                <h5>{{ component.name }}</h5>
                <p>{{ component.description }}</p>
              </div>
            </li>
          }
        </ul>
        <div class="form__actions">
          <button type="button" class="primary" (click)="confirmComponentModal()">Finish</button>
        </div>
      </div>
    </div>
  }

  @if (isSystemBoundaryModalOpen()) {
    <div class="modal-backdrop" (click)="closeSystemBoundaryModal()">
      <div class="modal" (click)="$event.stopPropagation()" role="dialog" aria-modal="true">
        <header class="modal__header">
          <h4>System boundary</h4>
          <button type="button" class="modal__close" (click)="closeSystemBoundaryModal()">×</button>
        </header>
        <form class="stack" [formGroup]="systemBoundaryModalForm">
          <label class="field">
            <textarea
              rows="12"
              formControlName="systemBoundaryText"
              placeholder="Describe the system boundary"
            ></textarea>
          </label>
          <div class="form__actions">
            <button type="button" class="primary" (click)="confirmSystemBoundaryModal()">Finish</button>
          </div>
        </form>
      </div>
    </div>
  }

  <section class="card lane">
    <header class="lane__header">
      <h3>1.2 — Safety concerns</h3>
      <p>
        Transition from mission framing to safety implications. Establish accidents, hazards, safety constraints,
        responsibilities, and artefacts that will connect with later iStar4Safety and STPA models.
      </p>
    </header>

    <div class="lane__grid">
      <article class="lane__block">
        <header>
          <h4>1.2.1 Identify unacceptable outcomes ({{ accidentCount() }})</h4>
          <p>Record accidents that motivate safety constraints.</p>
        </header>
        <form class="inline-form" [formGroup]="accidentForm" (ngSubmit)="addAccident()">
          <input type="text" formControlName="code" placeholder="Accident code" />
          <input type="text" formControlName="description" placeholder="Accident description" />
          <button type="submit">Add</button>
        </form>
        <ul class="list list--dense">
          @for (accident of accidents(); track accident.id) {
            <li>
              <div>
                <h5>{{ accident.code }}</h5>
                <p>{{ accident.description }}</p>
              </div>
            </li>
          }
        </ul>
      </article>

      <article class="lane__block">
        <header>
          <h4>1.2.2 Elicit system hazards ({{ hazardCount() }})</h4>
          <p>Map hazards back to the accidents they could trigger.</p>
        </header>
        <form class="stack" [formGroup]="hazardForm" (ngSubmit)="addHazard()">
          <label class="field">
            <span>Hazard code</span>
            <input type="text" formControlName="code" />
          </label>
          <label class="field">
            <span>Hazard description</span>
            <textarea rows="2" formControlName="description"></textarea>
          </label>
          <label class="field">
            <span>Related accidents</span>
            <input type="text" formControlName="linkedAccidents" placeholder="e.g. A1, A2" />
          </label>
          <button type="submit">Add hazard</button>
        </form>
        <table class="table">
          <thead>
            <tr>
              <th>Code</th>
              <th>Description</th>
              <th>Accidents</th>
            </tr>
          </thead>
          <tbody>
            @for (hazard of hazards(); track hazard.id) {
              <tr>
                <td>{{ hazard.code }}</td>
                <td>{{ hazard.description }}</td>
                <td>{{ hazard.linkedAccidents }}</td>
              </tr>
            }
          </tbody>
        </table>
      </article>

      <article class="lane__block">
        <header>
          <h4>1.2.3 Capture safety constraints</h4>
          <p>State how the socio-technical system prevents or mitigates the hazards.</p>
        </header>
        <form class="stack" [formGroup]="constraintForm" (ngSubmit)="addConstraint()">
          <label class="field">
            <span>Constraint code</span>
            <input type="text" formControlName="code" />
          </label>
          <label class="field">
            <span>Constraint statement</span>
            <textarea rows="2" formControlName="statement"></textarea>
          </label>
          <label class="field">
            <span>Hazards mitigated</span>
            <input type="text" formControlName="linkedHazards" placeholder="e.g. H1" />
          </label>
          <button type="submit">Record constraint</button>
        </form>
        <ul class="list list--dense">
          @for (constraint of constraints(); track constraint.id) {
            <li>
              <div>
                <h5>{{ constraint.code }} — {{ constraint.statement }}</h5>
                <p>Mitigates: {{ constraint.linkedHazards }}</p>
              </div>
            </li>
          }
        </ul>
      </article>

      <article class="lane__block">
        <header>
          <h4>1.2.4 Assign safety responsibilities</h4>
          <p>Trace responsibilities to the components catalogued in Substep 1.1.</p>
        </header>
        <form class="stack" [formGroup]="responsibilityForm" (ngSubmit)="addResponsibility()">
          <label class="field">
            <span>Component</span>
            <input type="text" formControlName="component" placeholder="Component" />
          </label>
          <label class="field">
            <span>Responsibility</span>
            <textarea rows="2" formControlName="responsibility"></textarea>
          </label>
          <label class="field">
            <span>Linked constraints</span>
            <input type="text" formControlName="linkedConstraints" placeholder="e.g. SC-01" />
          </label>
          <button type="submit">Add responsibility</button>
        </form>
        <table class="table">
          <thead>
            <tr>
              <th>Component</th>
              <th>Responsibility</th>
              <th>Constraints</th>
            </tr>
          </thead>
          <tbody>
            @for (responsibility of responsibilities(); track responsibility.id) {
              <tr>
                <td>{{ responsibility.component }}</td>
                <td>{{ responsibility.responsibility }}</td>
                <td>{{ responsibility.linkedConstraints }}</td>
              </tr>
            }
          </tbody>
        </table>
      </article>

      <article class="lane__block">
        <header>
          <h4>1.2.5 Register supporting artefacts</h4>
          <p>Record any artefact that substantiates the identified safety responsibilities.</p>
        </header>
        <form class="inline-form" [formGroup]="artefactForm" (ngSubmit)="addArtefact()">
          <input type="text" formControlName="name" placeholder="Artefact name" />
          <input type="text" formControlName="purpose" placeholder="Purpose" />
          <input type="text" formControlName="reference" placeholder="Repository or link" />
          <button type="submit">Add</button>
        </form>
        <ul class="list list--dense">
          @for (artefact of artefacts(); track artefact.id) {
            <li>
              <div>
                <h5>{{ artefact.name }}</h5>
                <p>{{ artefact.purpose }}</p>
                <p class="muted">{{ artefact.reference }}</p>
              </div>
            </li>
          }
        </ul>
      </article>
    </div>
  </section>

  <div class="page-actions page-actions--bottom">
    <button type="button" class="button button--secondary" (click)="saveStepOne()">Save</button>
    <button type="button" class="button" (click)="saveStepOne(true)">Save and Continue</button>
  </div>
</section>
